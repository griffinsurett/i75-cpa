---
// src/components/ContentBridge/ContentBridge.astro
/**
 * ContentBridge - Server-side content renderer for React components
 *
 * Renders Astro/MDX content server-side in hidden containers,
 * then passes slot IDs to React components as normal props.
 *
 * React components use standard DOM APIs (document.getElementById)
 * to access the pre-rendered content - no special hooks needed!
 *
 * Supports lazy rendering: if items have a `render` function instead of
 * a pre-rendered `Content` component, ContentBridge will call it to get
 * the Content. This avoids rendering content for items that don't need it.
 *
 * @example
 * <ContentBridge items={blogPosts} bridgeId="accordion">
 *   <Accordion
 *     items={blogPosts.map((item, i) => ({
 *       title: item.title,
 *       contentSlotId: `accordion-slot-${i}`
 *     }))}
 *     client:visible
 *   />
 * </ContentBridge>
 */

interface ContentItem {
  Content?: any;
  content?: string;
  /** Lazy render function - call to get Content component */
  render?: () => Promise<{ Content: any }>;
  [key: string]: any;
}

interface ResolvedItem {
  Content?: any;
  content?: string;
}

interface Props {
  /** Array of items with Content component, raw HTML, or render function */
  items: ContentItem[];
  /** Unique identifier for this bridge instance (used for DOM IDs) */
  bridgeId?: string | number;
  /** Additional CSS classes */
  className?: string;
}

const {
  items = [],
  bridgeId,
  className = "",
} = Astro.props as Props;

const normalizedBridgeId =
  (
    typeof bridgeId === "string"
      ? bridgeId.trim()
      : bridgeId != null
        ? String(bridgeId)
        : ""
  ) || "content-bridge";

// Resolve lazy render functions to Content components
// This is where the actual MDX rendering happens - only for items that use ContentBridge
const resolvedItems: ResolvedItem[] = await Promise.all(
  items.map(async (item) => {
    // If Content is already provided, use it
    if (item.Content) {
      return { Content: item.Content };
    }
    // If render function is provided, call it to get Content
    if (item.render) {
      try {
        const { Content } = await item.render();
        return { Content };
      } catch (e) {
        // Fallback to raw content if render fails
        return { content: item.content };
      }
    }
    // Fallback to raw HTML content
    return { content: item.content };
  })
);
---

<div class={`content-bridge ${className}`} data-bridge-id={normalizedBridgeId}>
  {/*
    Server-Side Rendering:
    Render all content in hidden containers with unique IDs
  */}
  {resolvedItems.map((item, index) => (
    <div
      id={`${normalizedBridgeId}-slot-${index}`}
      style="display: none;"
      data-bridge-slot={index}
    >
      {/* Render Astro component if available */}
      {item.Content ? (
        <item.Content />
      ) : /* Render raw HTML if provided */
      item.content ? (
        <div set:html={item.content} />
      ) : null}
    </div>
  ))}

  {/*
    React Component:
    Receives normal props (including contentSlotId strings)
    Uses document.getElementById() to access content
  */}
  <slot bridgeId={normalizedBridgeId} />
</div>
