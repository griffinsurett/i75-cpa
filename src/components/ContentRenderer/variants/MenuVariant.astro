---
// src/components/ContentRenderer/variants/MenuVariant.astro
/**
 * Menu Variant - Responsive Navigation Menu
 * 
 * Now expects items to be passed with potential parent relationships.
 * Builds tree structure from flat items.
 */

import type { BaseVariantProps } from "../ContentRenderer.types";
import Heading from "@/components/Heading";
import MenuList from '@/components/LoopTemplates/Menu/MenuList.astro';
import MobileMenuDrawer from '@/components/Menu/HamburgerMenuDrawer';
import { buildMenuTree } from '@/utils/menuQueries';
import { isTopLevelPlacement } from '@/utils/navigation/topLevelCheck';

type MenuMode = 'responsive' | 'flat-only' | 'hamburger-only';

interface Props extends BaseVariantProps {
  maxDepth?: number;
  mode?: MenuMode;
  closeButton?: boolean;
  hamburgerTransform?: boolean;
  listClassName?: string;
  submenuListClassName?: string;
  itemClassName?: string;
  linkClassName?: string;
  submenuLinkClassName?: string;
  showTitle?: boolean;
}

const {
  items = [],
  className = "",
  id,
  maxDepth = 3,
  mode = 'responsive',
  closeButton = false,
  hamburgerTransform = true,
  listClassName,
  submenuListClassName,
  itemClassName,
  linkClassName,
  submenuLinkClassName,
  title,
  headingTag = "h4",
  headingClassName,
  showTitle = false,
} = Astro.props as Props;

// Build hierarchical tree from flat items
const menuTree = buildMenuTree(items);

// Determine which versions to show based on mode
const showDesktop = mode === 'responsive' || mode === 'flat-only';
const showMobile = mode === 'responsive' || mode === 'hamburger-only';

// Responsive visibility classes
const desktopClasses = mode === 'responsive' ? 'hidden md:block' : '';
const mobileClasses =
  showMobile && mode === 'responsive' ? 'md:hidden' : '';

const inferredTopLevel = isTopLevelPlacement({
  id,
  className,
});

const useClientLoad =
  mode === 'hamburger-only' ? inferredTopLevel : false;

const mobileHydrationStrategy =
  mode === 'hamburger-only'
    ? useClientLoad
      ? 'load'
      : 'visible'
    : 'media';

const resolvedHeadingClassName =
  headingClassName ?? "h5 font-bold text-light-primary mb-4 uppercase tracking-wide";

const isFlatOnly = mode === "flat-only";
const flatListReset = "list-none m-0 p-0 !space-y-2";
const resolvedListClassName = isFlatOnly
  ? `${listClassName ?? ""} ${flatListReset}`.trim()
  : listClassName;
const resolvedSubmenuListClassName = isFlatOnly
  ? `${submenuListClassName ?? ""} ${flatListReset}`.trim()
  : submenuListClassName;
---
<div id={id} class={`menu-variant ${className}`}>
  {mode === "flat-only" && showTitle && title && (
    <Heading tagName={headingTag} className={resolvedHeadingClassName}>
      {title}
    </Heading>
  )}
  {showDesktop && (
    <nav class={`menu-desktop ${desktopClasses}`} aria-label="Main navigation">
      <MenuList
        items={menuTree}
        level={0}
        maxDepth={maxDepth}
        listClassName={resolvedListClassName}
        submenuListClassName={resolvedSubmenuListClassName}
        itemClassName={itemClassName}
        linkClassName={linkClassName}
        submenuLinkClassName={submenuLinkClassName}
      />
    </nav>
  )}
  
  {showMobile && (
    <div class={`menu-mobile ${mobileClasses}`}>
      {mobileHydrationStrategy === 'load' && (
        <MobileMenuDrawer
          items={menuTree}
          closeButton={closeButton}
          hamburgerTransform={hamburgerTransform}
          client:load
        />
      )}
      {mobileHydrationStrategy === 'visible' && (
        <MobileMenuDrawer
          items={menuTree}
          closeButton={closeButton}
          hamburgerTransform={hamburgerTransform}
          client:visible
        />
      )}
      {mobileHydrationStrategy === 'media' && (
        <MobileMenuDrawer
          items={menuTree}
          closeButton={closeButton}
          hamburgerTransform={hamburgerTransform}
          client:media="(max-width: 768px)"
        />
      )}
    </div>
  )}
</div>
