---
// src/components/LoopComponents/ArticleCard.astro
/**
 * Article Card Component
 *
 * Card component for displaying blog posts/articles with:
 * - Title with optional link
 * - Description with line clamping
 * - Publication date
 * - Tags (max 3 shown)
 * - Author information with avatar/initials
 *
 * Used in BlogVariant for blog post listings.
 * Author data is queried on-demand from references.
 */

import { find, isCollectionReference } from "@/utils/query";

export interface Props {
  title: string;
  url?: string;
  description?: string;
  date?: Date | string;
  tags?: string[];
  author?: any; // Reference object: { collection: 'authors', id: 'jane-doe' }
}

const { title, url, description, date, tags, author } = Astro.props;

// Query for author data if reference exists
let authorData: Record<string, any> | null = null;
if (isCollectionReference(author)) {
  const authorEntry = await find(author.collection, author.id);
  if (authorEntry) {
    authorData = authorEntry.data as Record<string, any>;
  }
}

// Extract author display data
const authorName = authorData?.title || authorData?.name || "";
const authorRole = authorData?.role || "";

// Generate initials from name
const authorInitials =
  authorData?.initials ||
  (authorName
    ? authorName
        .split(" ")
        .map((w: string) => w[0])
        .join("")
        .toUpperCase()
    : "??");
---

<article
  class="bg-bg rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow"
>
  <div class="p-6">
    {/* Article metadata and content */}
    <div class="mb-4">
      {/* Tags - show first 3 */}
      {
        tags && tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-3">
            {tags.slice(0, 3).map((tag: string) => (
              <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded">
                {tag}
              </span>
            ))}
          </div>
        )
      }

      {/* Title - linked if URL provided */}
      <h3 class="text-2xl font-bold mb-2">
        {
          url ? (
            <a
              href={url}
              class="text-heading hover:text-primary transition-colors"
            >
              {title}
            </a>
          ) : (
            <span class="text-heading">{title}</span>
          )
        }
      </h3>

      {/* Description with 2-line clamp */}
      {description && <p class="text-text mb-4 line-clamp-2">{description}</p>}

      {/* Publication date */}
      <div class="flex items-center text-sm text-text gap-4">
        {date && <time>{new Date(date).toLocaleDateString()}</time>}
      </div>
    </div>

    {/* Author info with avatar */}
    {
      authorName && (
        <div class="pt-4 mt-4 border-t border-surface">
          <div class="flex items-center gap-3">
            {/* Avatar circle with initials */}
            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
              <span class="text-primary text-sm font-bold">
                {authorInitials}
              </span>
            </div>
            <div>
              <p class="font-medium text-heading">{authorName}</p>
              {authorRole && <p class="text-xs text-text">{authorRole}</p>}
            </div>
          </div>
        </div>
      )
    }
  </div>
</article>

<style>
  /* CSS for 2-line text truncation */
  .line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
  }
</style>
