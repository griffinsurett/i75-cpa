---
// src/components/Form/forms/FreeTrialForm.astro
/**
 * Free Trial Form - For CPA exam free trial signups
 */
import Button from "@/components/Button/Button";
import FormWrapper from "@/components/Form/FormWrapper";
import Input from "@/components/Form/inputs/Input";
import Textarea from "@/components/Form/inputs/Textarea";
import Checkbox from "@/components/Form/inputs/Checkbox";
import CheckboxParts from "@/components/Form/CheckboxParts.astro";
import { submitToFormspree } from "@/utils/formspree";
import { hasParent } from "@/utils/query";

interface Props {
  title?: string;
  description?: string;
  className?: string;
}

const { title, description, className = "" } = Astro.props;

const FORMSPREE_BASE_ACTION = "https://formspree.io/f/";
const freeTrialFormId = import.meta.env.PUBLIC_FORMSPREE_FREE_TRIAL_ID;
const freeTrialFormAction = freeTrialFormId
  ? `${FORMSPREE_BASE_ACTION}${freeTrialFormId}`
  : undefined;

const handleSubmit = async (values: Record<string, unknown>) => {
  if (!freeTrialFormAction) {
    throw new Error("Free trial form is temporarily unavailable. Please try again later.");
  }

  await submitToFormspree({
    endpoint: freeTrialFormAction,
    values,
    formName: "Free Trial Request",
    excludeKeys: ["privacy"],
  });
};

const partEntries = (await hasParent("part").get()).entries;
const partOptions = partEntries.map((entry) => ({
  value: entry.slug,
  label: entry.data.title || entry.slug,
}));
---

<div class={className}>
  {title && <h2 class="text-3xl font-bold mb-3">{title}</h2>}
  {description && <p class="text-text mb-8">{description}</p>}

  <FormWrapper
    client:idle
    onSubmit={handleSubmit}
    successMessage="Welcome to i75 CPA Review! Check your email for instructions to access your free trial."
    errorMessage="There was an error submitting your request. Please try again."
    resetOnSuccess={true}
    className="w-full"
  >
    <div class="flex flex-col lg:flex-row justify-between gap-2 mb-4">
      <Input
        name="firstName"
        label="First Name"
        type="text"
        required={true}
        minLength={2}
        placeholder="First Name"
        containerClassName="mb-0 flex-1"
        inputClassName="w-full px-4 py-3 bg-surface border-0 rounded-md focus:outline-none focus:ring-2 focus:ring-MainDark"
      />

      <Input
        name="lastName"
        label="Last Name"
        type="text"
        required={true}
        minLength={2}
        placeholder="Last Name"
        containerClassName="mb-0 flex-1"
        inputClassName="w-full px-4 py-3 bg-surface border-0 rounded-md focus:outline-none focus:ring-2 focus:ring-MainDark"
      />
    </div>

    <Input
      name="email"
      label="Email"
      type="email"
      required={true}
      placeholder="your.email@example.com"
      containerClassName="mb-4"
      inputClassName="w-full px-4 py-3 bg-surface border-0 rounded-md focus:outline-none focus:ring-2 focus:ring-MainDark"
    />

    <Input
      name="country"
      label="Country"
      type="text"
      placeholder="Country"
      containerClassName="mb-4"
      inputClassName="w-full px-4 py-3 bg-surface border-0 rounded-md focus:outline-none focus:ring-2 focus:ring-MainDark"
    />

    <fieldset class="mb-4">
      <legend class="block text-sm font-medium text-text mb-2">
        Which Part Would You Like for Your Free Trial?
        <span class="text-red-500 ml-1">*</span>
      </legend>
      <div class="space-y-2">
        {partOptions.map((part) => (
          <label class="flex items-center gap-2 text-text" for={`desiredPart-${part.value}`}>
            <input
              id={`desiredPart-${part.value}`}
              type="radio"
              name="desiredPart"
              value={part.label}
              required
              class="w-4 h-4 text-MainDark border-surface"
            />
            <span>{part.label}</span>
          </label>
        ))}
      </div>
    </fieldset>

    <CheckboxParts
      name="passedParts"
      label="What Parts Have You Already Passed?"
      includeNone={true}
    />

    <Textarea
      name="examJourney"
      label="Include a brief history of your CPA exam journey, what CPA review materials you've used, your expectations, and how you feel about them now"
      required={true}
      minLength={20}
      placeholder="Share your CPA exam journey..."
      rows={5}
      containerClassName="mb-4"
      textareaClassName="w-full px-4 py-3 bg-surface border-0 rounded-md focus:outline-none focus:ring-2 focus:ring-MainDark resize-vertical"
    />

    <Checkbox
      name="privacy"
      required
      containerClassName="mb-6"
      checkboxClassName="w-4 h-4 text-MainDark border-surface rounded"
    >
      I consent to have this website store my submitted information so they can respond to my inquiry
    </Checkbox>

    <Button variant="secondary" type="submit" className="w-full mx-auto">
      Start My Free Trial
    </Button>
  </FormWrapper>
</div>
